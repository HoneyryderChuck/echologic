<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title><%= I18n.t('mailers.activity_tracking.subject', :locale => @language.code) %></title>
  </head>

  <body>
  	<h2><%= I18n.t('mailers.activity_tracking.subject', :locale => @language.code) %></h2>

		<%= render :partial => "activity_tracking_mailer/activity_templates/questions_activity_template",
               :locals => {:questions => @question_events, :tags => @question_tags}%>

    <br/>

    <% current_question = nil %>
    <% current_proposal = nil %>
    <% @events.each do |e|%>
      <% event_data = JSON.parse(e.event) %>
			<%
        ["root_","parent_",""].each do |type|
          instance_variable_set("@#{type}title",nil)
          next if event_data["#{type}documents"].nil?
	        @preferred_language_ids.each do |l_id|
	          if event_data["#{type}documents"].has_key?(l_id)
	            instance_variable_set("@#{type}title",event_data["#{type}documents"][l_id])
	            break
	          end
	         end
	         instance_variable_set("@#{type}title",event_data["#{type}documents"].to_a[0][1]) if instance_variable_get("@#{type}title").nil? 
         end
      %>
			<% if event_data['parent_type'] == 'question' and event_data['parent_id'] != current_question %>
        <% current_question = event_data['parent_id'] %>
          <br/>
          <%= I18n.t('mailers.activity_tracking.discussions.new_proposals',
                     :title => @parent_title, :locale => @language.code) %>
          <ul>
      <% elsif event_data['parent_type'] == 'proposal' and event_data['parent_id'] != current_proposal %>
        <% current_proposal = event_data['parent_id'] %>
          </ul>
          <br/>
          <%= I18n.t('mailers.activity_tracking.discussions.new_improvement_proposals',
                     :title => @parent_title, :question_title => @root_title, :locale => @language.code) %>
          <ul>
      <% end %>
      <li>
        <%= render :partial => "activity_tracking_mailer/activity_templates/#{event_data['type']}_activity_template",
                   :locals => {:title => @title, :event => e} %>
      </li>
    <% end %>
    </ul>

    <p><%= I18n.t('mailers.signature_as_html', :locale => @language.code) %></p>
    <br/>
    <p><%= I18n.t('mailers.activity_tracking.unsubscribe', :echo_url => root_url, :locale => @language.code) %></p>

  </body>
</html>

