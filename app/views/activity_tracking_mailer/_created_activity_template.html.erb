<%
  ["root_","parent_",""].each do |type|
    instance_variable_set("@#{type}title",nil)
    next if event_data["#{type}documents"].nil?
    @preferred_language_ids.each do |l_id|
      if event_data["#{type}documents"].has_key?(l_id)
        instance_variable_set("@#{type}title",event_data["#{type}documents"][l_id])
        break
      end
     end
     instance_variable_set("@#{type}title",event_data["#{type}documents"].to_a[0][1]) if instance_variable_get("@#{type}title").nil? 
   end
%>
<% if previous_event_data.nil? or event_data['parent_id'] != previous_event_data['parent_id'] %>
	<br/>
	</ul>
	<% if event_data['type'] == 'proposal' %>
	    <%= I18n.t('mailers.activity_tracking.discussions.new_proposals',
	               :title => @parent_title, :locale => @language.code) %>
	<% elsif event_data['type'] == 'improvement_proposal' %>
	    <%= I18n.t('mailers.activity_tracking.discussions.new_improvement_proposals',
	               :title => @parent_title, :question_title => @root_title, :locale => @language.code) %>
	<% end %>
	<ul>
<% end %>
<%= render :partial => "activity_tracking_mailer/activity_templates/#{event_data['type']}_activity_template",
             :locals => {:title => @title, :event_data => event_data} %>
